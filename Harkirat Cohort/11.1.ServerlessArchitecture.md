# Serverless Architecture

When you have to deploy Backend Server on the internet, there are a few ways - 
- Go to aws, GCP, Azure, Cloudflare
- Rent a VM (Virtual Machine) and deploy your app
- Put it in an Auto scaling group
- Deploy it in a Kubernetes cluster


There are a few downsides to doing this - 
- Taking care of how/when to scale
- Base cost even if no one is visiting your website
- Monitoring various servers to make sure no server is down


"Serverless" is a backend deployment in which the cloud provider dynamically manages the allocation and provisioning of servers, developers and operators do not have to worry about the servers.

Serverless, you just write routes and run a command, the app automatically deploy, autoscale, and charge as per request basis.
But problem here is More expensive at scale and cold start problem.

Famous serverless providers example: AWS Lambda, Google Cloud Functions, Cloudflare Workers.

**Cloudflare workers DONT use the Node.js runtime. They have created their own runtime.**
Under the hood the workers runtime uses V8 engine. Rather than running on the individual's machine, worker functions run on a Cloudflare's Edge Network, a growing global network of thousands of machine distributed accross hundreds of locations.

[see this](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2F34612f53-8340-455b-9ea5-a7ecbfed76e7%2FScreenshot_2024-02-10_at_3.51.07_AM.jpg?table=block&id=05510132-8f7d-448b-bd2a-0a03319c647f&cache=v2)

[see this](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2Feac4cf16-3350-4f8b-aa6e-98322a23d7fa%2FScreenshot_2024-02-10_at_3.54.02_AM.jpg?table=block&id=dde817ce-f77f-4a17-add4-f8297d8107fe&cache=v2)




**Initializing a worker**: "npm create cloudflare -- my-app"

```jsx
    import express from "express"
    const app = express();

    app.get("/route", (req, res) => {
        // handles a get request to /route
    });
```
Same thing in cloudflare environment:
```jsx
    export default {
        async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
            console.log(request.body);
            console.log(request.headers);
            
            if (request.method === "GET") {
                return Response.json({
                    message: "you sent a get request"
                });
            } else {
                return Response.json({
                    message: "you did not send a get request"
                });
            }
        },
    };
```




To deploy worker on internet we use wrangler for it.
[Wrangler (command line)](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2Fede31e52-2585-4793-ae31-646e4011419b%2FScreenshot_2024-02-10_at_3.58.30_AM.jpg?table=block&id=dcd69cc6-23b5-4435-bad4-c64f959adef9&cache=v2)

"npx wrangler login"
"npm run deploy"

**Assigning a custom domain**
- You have to buy a plan to be able to do this
- You also need to buy the domain on cloudflare/transfer the domain to cloudflare


Now, we cant use express in here, as it heavily relies on Node.js. We can use some options in place of express in here:
- honojs/hono
- lukeed/worktop
- kwhitley/itty-router


If we can split our app in small components and we dont need to rely heavily on node.js... Just like this [separate logic](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F085e8ad8-528e-47d7-8922-a23dc4016453%2Fd56c54ff-12ee-4b9e-bda6-699641b27bea%2FScreenshot_2024-02-10_at_4.37.24_AM.jpg?table=block&id=44cd75c5-27b8-4e0b-bf94-d4c1bf546581&cache=v2)


We use hono as a framework for cloudflare workers
"npm create hono@latest my-app"

```jsx
    import { Hono } from 'hono'

    const app = new Hono()

    app.get('/', async (c) => {
        const body = await c.req.json()
        console.log(body);
        console.log(c.req.header("Authorization"));
        console.log(c.req.query("param"));

        return c.text('Hello Hono!')
    })

    export default app
```

then "npx wrangler login" then "npm run deploy"


To use middleware:
```jsx
    import { Hono, Next } from 'hono'
    import { Context } from 'hono/jsx';

    const app = new Hono()

    app.use(async (c, next) => {
        if (c.req.header("Authorization")) {
            // Do validation
            await next()
        } else {
            return c.text("You dont have acces");
        }
    })

    app.get('/', async (c) => {
        const body = await c.req.parseBody()
        console.log(body);
        console.log(c.req.header("Authorization"));
        console.log(c.req.query("param"));

        return c.json({msg: "as"})
    })

    export default app
```